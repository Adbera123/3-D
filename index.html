<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Scene with Optional AR</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #enter-ar {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1;
    }
  </style>
</head>
<body>
  <script type="module">
    console.log('Script started');

    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.1/examples/jsm/loaders/GLTFLoader.js';
    import { ARButton } from 'https://cdn.jsdelivr.net/npm/three@0.160.1/examples/jsm/webxr/ARButton.js';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xeeeeee);

    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 1, 3);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
    directionalLight.position.set(2, 2, 5);
    scene.add(directionalLight);

    const loader = new GLTFLoader();
    let model = null;

    loader.load(
      './DamagedHelmet.glb',  // Шлях до моделі відносно index.html
      function (gltf) {
        console.log('Model loaded successfully');
        model = gltf.scene;
        model.scale.set(1, 1, 1);
        model.position.set(0, 0, -1); // перед камерою
        scene.add(model);
      },
      function (xhr) {
        if (xhr.lengthComputable) {
          console.log(`Model loading: ${((xhr.loaded / xhr.total) * 100).toFixed(2)}%`);
        }
      },
      function (error) {
        console.error('Error loading model:', error);
      }
    );

    // Запускаємо рендеринг у звичайному (не AR) режимі
    function launchNonARMode() {
      console.log('Launching non-AR mode');
      renderer.xr.enabled = false;

      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }

      animate();
    }

    // Перевірка підтримки WebXR і запуск AR або звичайного режиму
    if (navigator.xr) {
      navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
        console.log('AR supported:', supported);
        if (supported) {
          document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));
          renderer.setAnimationLoop(() => {
            renderer.render(scene, camera);
          });
        } else {
          console.log('AR not supported, fallback to non-AR mode');
          launchNonARMode();
        }
      }).catch((err) => {
        console.error('XR check failed:', err);
        launchNonARMode();
      });
    } else {
      console.log('WebXR not supported');
      launchNonARMode();
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
